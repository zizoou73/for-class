<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: url('images/background.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: right;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
            width: 92%;
            max-width: 920px;
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 18px;
            position: relative;
            align-items: start;
        }
.question img {
    width: 70% !important;  /* ÙŠØ¬Ø¨Ø± Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù„Ù‰ ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© */
    max-width: 800px !important;  /* ÙŠØ³Ù…Ø­ Ø¨Ø­Ø¬Ù… Ø£ÙƒØ¨Ø± */
    display: block;
margin: 20px 10% 20px auto;
}
        .header {
            font-size: 26px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 6px;
            text-align: center;
            grid-column: 1 / -1;
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }
        .action-btn {
            background: #4a6baf;
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.18s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
            text-align: center;
            font-size: 14px;
            width: 100%;
        }
        .action-btn:hover { transform: translateY(-3px); }
        .action-btn:disabled { background:#cccccc; cursor:not-allowed; transform:none; box-shadow:none; }
        .help-message { color:#e67e22; font-size:13px; height:18px; text-align:center; }
        #current-score { font-weight:bold; color:#2c3e50; background:#eaf7ea; padding:6px 12px; border-radius:20px; text-align:center; }
        #timer { font-size:20px; font-weight:bold; padding:6px 10px; border-radius:20px; display:inline-block; text-align:center; }
        .question-container { padding: 0 10px; }
        .progress-container { width:100%; background:#e9ecef; border-radius:10px; overflow:hidden; height:22px; margin-bottom:8px; }
        .progress-bar { height:100%; width:0%; background:linear-gradient(90deg,#4CAF50 0%,#8BC34A 100%); transition:width .5s; text-align:center; color:white; font-weight:bold; font-size:13px; line-height:22px; }
        .question { margin-top:6px; display:flex; gap:12px; align-items:center; justify-content:flex-end; }
        .question img { max-width: 60%; height: auto; max-height: 160px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); object-fit:contain; }
        .options { list-style:none; padding:0; margin:18px 0 0 0; display:grid; grid-template-columns:repeat(2,1fr); gap:16px; }
        .options li { cursor:pointer; transition:all .18s; background:#fbfbfd; padding:12px; border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.06); border:2px solid #eef0f3; text-align:center; min-height:110px; display:flex; align-items:center; justify-content:center; }
        .options li:hover { transform:scale(1.03); box-shadow:0 8px 20px rgba(0,0,0,0.12); border-color:#4a6baf; }
        .options li img { max-width:100%; max-height:100%; object-fit:contain; }
        .options li.disabled-option { opacity:0.35; pointer-events:none; cursor:not-allowed; transform:none; }
        .message { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.9); color: white; padding: 26px; border-radius: 12px; font-size: 22px; font-weight: bold; text-align: center; display:none; z-index: 2000; width:85%; max-width:620px; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        .correct { color:#4CAF50; }
        .wrong { color:#e74c3c; }
        /* small screens */
        @media (max-width:800px){
            .container { grid-template-columns: 1fr; padding:14px; }
            .sidebar { flex-direction:row; flex-wrap:wrap; justify-content:center; gap:8px; }
            .question img { max-width:60%; }
            .options { grid-template-columns:1fr; }
            .options li { min-height:80px; }
            .progress-bar { font-size:12px; }
        }

        /* Circular timer styling container */
        .timer-wrap { display:flex; gap:8px; align-items:center; justify-content:center; flex-direction:column; }
        .circle-timer { width:68px; height:68px; position:relative; }
        .circle-timer svg { transform: rotate(-90deg); width:100%; height:100%; }
        .circle-label { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; }
        /* entrance animations */
        .fade-in { animation: fadeIn .28s ease both; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform:none; } }
    </style>
</head>
<body>
    <div class="container fade-in" id="app">
        <div class="header">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© ğŸ§®</div>

        <div class="sidebar">
            <button class="action-btn" onclick="useFiftyFifty()" id="fiftyBtn">Ù…Ø³Ø§Ø¹Ø¯Ø© 50/50 (-0.5)</button>
            <button class="action-btn" onclick="skipQuestion()" id="skipBtn">ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ (-0.5)</button>
            <button class="action-btn" onclick="showLeaderboard()">Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ† ğŸ†</button>
            <div class="help-message" id="helpMessage"></div>

            <div id="current-score">Ø§Ù„Ù†Ù‚Ø§Ø·: 5.0</div>

            <div class="timer-wrap" title="Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ">
                <div id="timer" style="display:none;">60</div>
                <div class="circle-timer" aria-hidden="true">
                    <svg id="timer-svg" viewBox="0 0 100 100" role="img" aria-label="Ù…Ø¤Ù‚Øª">
                        <defs>
                            <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#4CAF50" />
                                <stop offset="100%" stop-color="#4CAF50" />
                            </linearGradient>
                        </defs>
                        <circle cx="50" cy="50" r="44" stroke="#eee" stroke-width="8" fill="none"></circle>
                        <circle id="timer-circle" cx="50" cy="50" r="44" stroke="url(#grad)" stroke-width="8" stroke-linecap="round" fill="none" stroke-dasharray="276.46" stroke-dashoffset="0"></circle>
                    </svg>
                    <div class="circle-label" id="circle-label">60</div>
                </div>
            </div>

        </div>

        <div class="question-container">
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar">0%</div>
            </div>

            <div id="question-counter">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 10</div>
            <div class="question" id="question"></div>
            <ul class="options" id="options"></ul>
        </div>
    </div>

    <div class="message" id="message"></div>

    <audio id="correct-sound" src="sounds/success.mp3"></audio>
    <audio id="wrong-sound" src="sounds/error.mp3"></audio>
    <audio id="thinking-sound" src="sounds/thinking.mp3"></audio>
    <audio id="tick-sound" src="sounds/tick.mp3"></audio>

    <script>
        /* ==========  Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ùˆ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ========== */
        const TOTAL_QUESTIONS_POOL = 78; // Ø¹Ø¯Ø¯ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ q/
        let allQuestions = Array.from({length: TOTAL_QUESTIONS_POOL}, (_, i) => {
            const n = i + 1;
            return {
                id: n,
                questionImage: `q/question${n}.png`,
                options: [
                    `answers/q${n}_answer1.png`,
                    `answers/q${n}_answer2.png`,
                    `answers/q${n}_answer3.png`,
                    `answers/q${n}_answer4.png`
                ],
                correctIndex: 0 // Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ¯Ø±ÙŠØ© ÙƒÙ…Ø§ ÙÙŠ Ø·Ù„Ø¨Ùƒ
            };
        });

        /* ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ===== */
        let questions = []; // 10 Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        let availableQuestions = []; // Ø£Ø³Ø¦Ù„Ø© Ù„Ù… ØªÙØ³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø¹Ø¨Ø± Ø§Ù„Ø¬ÙˆÙ„Ø§Øª
        let currentQuestion = 0;
        let helpUsed = false;
        let disabledOptions = [];
        let timeLeft = 60;
        let timerInterval = null;
        let gameStartTime = 0;
        let questionStartTime = 0;
        let currentShuffledOptions = []; // Ø®Ø±Ø§Ø¦Ø· Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
        let currentCorrectIndex = null; // index Ø¯Ø§Ø®Ù„ Ø§Ù„-shuffled options
        let audioUnlocked = false; // Ù„ØªØ¬Ø§ÙˆØ² Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ù…ØªØµÙØ­Ø§Øª: Ù†ÙØ¹Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

        /* ===== Ø¹Ù†Ø§ØµØ± DOM ===== */
        const progressBarEl = document.getElementById('progress-bar');
        const questionEl = document.getElementById('question');
        const optionsEl = document.getElementById('options');
        const messageEl = document.getElementById('message');
        const scoreEl = document.getElementById('current-score');
        const fiftyBtn = document.getElementById('fiftyBtn');
        const helpMessageEl = document.getElementById('helpMessage');
        const circleLabelEl = document.getElementById('circle-label');
        const timerCircle = document.getElementById('timer-circle');
        const timerSVG = document.getElementById('timer-svg');

        /* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨ ===== */
        const QUESTIONS_PER_GAME = 10;
        const START_SCORE = 5.0;
        const TIME_PER_QUESTION = 60; // Ø«Ø§Ù†ÙŠØ©
        const FAST_THRESHOLD = 30; // Ø®Ù„Ø§Ù„ 30 Ø«Ø§Ù†ÙŠØ© = Ø³Ø±ÙŠØ¹ (+2)
        const FIFTY_COST = 0.5;
        const SKIP_COST = 0.5;

        /* ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ===== */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function preloadImages() {
            allQuestions.forEach(q => {
                const iq = new Image(); iq.src = q.questionImage;
                q.options.forEach(src => { const im = new Image(); im.src = src; });
            });
        }

        /* ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¬ÙˆÙ„Ø§Øª ========== */
        function loadAvailableQuestionsFromStorage() {
            let used = JSON.parse(localStorage.getItem('usedQuestions')) || [];
            // Ø¥Ø°Ø§ Ø§Ø³ØªÙÙ‡Ù„ÙƒØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©ØŒ Ù†Ø¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ø¬Ù„
            if (used.length >= allQuestions.length) {
                used = [];
                localStorage.setItem('usedQuestions', JSON.stringify([]));
            }
            // available = ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ Ù„Ù… ØªÙØ³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯
            availableQuestions = allQuestions.filter(q => !used.includes(q.id));
        }

        /* ========== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ======== */
        function initGame() {
            // ØªÙØ¹ÙŠÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù…Ø³Ø¨Ù‚Ù‹Ø§
            preloadImages();

            // ØªÙ‡ÙŠØ¦Ø© scoreboard Ùˆ usedQuestions
            loadAvailableQuestionsFromStorage();
            questions = [];

            // Ù†Ø®ØªØ§Ø± QUESTIONS_PER_GAME Ø¹Ø´ÙˆØ§Ø¦ÙŠÙ‹Ø§ Ù…Ù† availableQuestions
            const temp = [...availableQuestions];
            for (let i = 0; i < Math.min(QUESTIONS_PER_GAME, temp.length); i++) {
                const idx = Math.floor(Math.random() * temp.length);
                questions.push(temp[idx]);
                // Ø³Ù†Ù‚ÙˆÙ… Ø¨ÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙƒÙŠ Ù„Ø§ ØªÙØ³ØªØ®Ø¯Ù… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¹Ø¨Ø± Ø¬ÙˆÙ„Ø§Øª Ù„Ø§Ø­Ù‚Ø©
                const used = JSON.parse(localStorage.getItem('usedQuestions')) || [];
                used.push(temp[idx].id);
                localStorage.setItem('usedQuestions', JSON.stringify(used));
                // ÙˆÙ†Ø²ÙŠÙ„Ù‡Ø§ Ù…Ù† temp Ùˆ from availableQuestions
                temp.splice(idx, 1);
            }

            // ØªØ­Ø¯ÙŠØ« availableQuestions (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©)
            loadAvailableQuestionsFromStorage();

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ©
            localStorage.setItem('quizScore', START_SCORE.toFixed(1));
            updateScoreDisplay();

            currentQuestion = 0;
            gameStartTime = Date.now();
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„
            loadQuestion();
        }

        /* ===== Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… ===== */
        function updateProgress() {
            const progress = ((currentQuestion) / questions.length) * 100;
            progressBarEl.style.width = progress + '%';
            progressBarEl.textContent = Math.round(progress) + '%';
            document.getElementById("question-counter").textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestion + 1} Ù…Ù† ${questions.length}`;
        }

        /* ===== Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ ===== */
        const FULL_DASH_ARRAY = 2 * Math.PI * 44; // 2Ï€r where r = 44
        timerCircle.style.strokeDasharray = FULL_DASH_ARRAY;
        function setCircleTimeFraction(timeLeftSec) {
            const fraction = timeLeftSec / TIME_PER_QUESTION;
            const offset = FULL_DASH_ARRAY * (1 - fraction);
            timerCircle.style.strokeDashoffset = offset;
        }
        function setTimerColor(seconds) {
            // Ø£Ø®Ø¶Ø± 60-30ØŒ Ø£ØµÙØ± 30-10ØŒ Ø£Ø­Ù…Ø± 10-0 Ù…Ø¹ Ø§Ù†ØªÙ‚Ø§Ù„ Ù†Ø§Ø¹Ù…
            const circle = timerCircle;
            if (seconds > 30) {
                // Ø£Ø®Ø¶Ø±
                circle.style.stroke = 'url(#grad)';
                // adjust gradient stops
                timerSVG.querySelector('stop').setAttribute('stop-color', '#4CAF50');
                timerSVG.querySelectorAll('stop')[1].setAttribute('stop-color', '#4CAF50');
            } else if (seconds > 10) {
                timerSVG.querySelector('stop').setAttribute('stop-color', '#f1c40f');
                timerSVG.querySelectorAll('stop')[1].setAttribute('stop-color', '#f1c40f');
                circle.style.stroke = 'url(#grad)';
            } else {
                timerSVG.querySelector('stop').setAttribute('stop-color', '#e74c3c');
                timerSVG.querySelectorAll('stop')[1].setAttribute('stop-color', '#e74c3c');
                circle.style.stroke = 'url(#grad)';
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = TIME_PER_QUESTION;
            updateTimerUI();
            setCircleTimeFraction(timeLeft);
            setTimerColor(timeLeft);
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerUI();
                setCircleTimeFraction(timeLeft);
                setTimerColor(timeLeft);

                // Ø£ØµÙˆØ§Øª Ø§Ù„ØªÙƒØªÙƒØ© Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¨Ù‚Ù‰ Ø£Ù‚Ù„ Ù…Ù† 10 Ø£Ùˆ  <=10
                if (timeLeft <= 10 && timeLeft > 0) {
                    const tick = document.getElementById('tick-sound');
                    tick.currentTime = 0;
                    // ØªØ³Ø±Ù‘Ø¹ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯Ù…Ø§ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£Ù‚Ù„ Ù…Ù† 5
                    tick.playbackRate = timeLeft <= 5 ? 1.5 : 1.0;
                    safePlayAudio(tick);
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    // ÙŠØ¹ØªØ¨Ø± ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
                    checkAnswer(false, true); // Ù…Ø±Ù‘Øª Ø§Ù„Ù…Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø¬Ø§Ø¨Ø©
                }
            }, 1000);
        }

        function updateTimerUI() {
            circleLabelEl.textContent = timeLeft;
            // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ø¥Ù„Ø§ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù„ÙŠØ© Ø¥Ù† Ù„Ø²Ù…
            document.getElementById('timer').textContent = timeLeft;
        }

        /* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø¹Ø±Ø¶ ===== */
        function loadQuestion() {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…
            helpUsed = false;
            disabledOptions = [];
            fiftyBtn.disabled = false;
            helpMessageEl.textContent = "";
            // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØµÙˆØª ØªÙÙƒÙŠØ± Ø³Ø§Ø¨Ù‚
            const thinking = document.getElementById('thinking-sound');
            thinking.pause();
            thinking.currentTime = 0;

            // Ø¹Ù†ØµØ± Ø§Ù„Ø³Ø¤Ø§Ù„
            const q = questions[currentQuestion];
            if (!q) {
                // Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø£ÙƒØ«Ø±ØŒ Ø£Ù†Ù‡Ù Ø§Ù„Ù„Ø¹Ø¨Ø©
                endGame();
                return;
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯ ØµÙˆØ± Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª (Ø¹Ø±Ø¶ Ø¨ØªØ±ØªÙŠØ¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠØŒ Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù…Ø¹Ø±ÙØ© Ø£ÙŠÙ‡Ø§ Ø§Ù„ØµØ­ÙŠØ­)
            const shuffledOptions = shuffleArray([...q.options]);
            currentShuffledOptions = shuffledOptions;
            currentCorrectIndex = shuffledOptions.indexOf(q.options[q.correctIndex]);

            // DOM: Ø³Ø¤Ø§Ù„
            questionEl.innerHTML = `<img src="${q.questionImage}" alt="Ø³Ø¤Ø§Ù„ ${q.id}">`;

            // DOM: Ø®ÙŠØ§Ø±Ø§Øª
            const optionsHTML = shuffledOptions.map((opt, idx) => {
                return `<li onclick="checkAnswer(${idx === currentCorrectIndex})" class="${disabledOptions.includes(idx) ? 'disabled-option' : ''}">
                    <img src="${opt}" alt="Ø¥Ø¬Ø§Ø¨Ø© ${idx+1}">
                </li>`;
            }).join('');
            optionsEl.innerHTML = optionsHTML;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ù…ÙˆÙ‚Øª
            updateProgress();
            questionStartTime = Date.now();
            startTimer();

            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙÙƒÙŠØ± (Ù…Ø±Ù‘ØªÙŠÙ†: Ù…Ø±Ù‘Ø© Ø¨Ø¹Ø¯ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙˆØ¥Ù„Ø§ Ù„Ù† ÙŠØ´ØºÙ„)
            const playThinkingIfPossible = () => safePlayAudio(thinking);
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØµÙˆØª Ù…ÙÙ…ÙƒÙ‘Ù†ØŒ Ø´ØºÙ‘Ù„Ù‡ ÙÙˆØ±Ø§Ù‹Ø› ÙˆØ¥Ù„Ø§ Ø§Ù†ØªØ¸Ø± Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„
            if (audioUnlocked) playThinkingIfPossible();
            else {
                // Ù†Ø¶ÙŠÙ Ù…Ø³ØªÙ…Ø¹ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØµÙˆØª ÙˆØªØ´ØºÙŠÙ„Ù‡
                document.body.addEventListener('pointerdown', function once() {
                    audioUnlocked = true;
                    playThinkingIfPossible();
                    document.body.removeEventListener('pointerdown', once);
                }, { once: true });
            }
        }

        /* ===== ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© =====
           isCorrect: boolean
           timedOut: boolean (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø³Ø¨Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª)
        */
        function checkAnswer(isCorrect, timedOut = false) {
            clearInterval(timerInterval);
            const messageBox = messageEl;
            messageBox.style.display = "block";
            if (isCorrect) {
                messageBox.innerHTML = '<span class="correct">âœ” Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!</span>';
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·: Ø²Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
                const answerTime = Math.floor((Date.now() - questionStartTime) / 1000);
                const currentScore = parseFloat(localStorage.getItem('quizScore')) || START_SCORE;
                const pointsToAdd = (answerTime <= FAST_THRESHOLD) ? 2 : 1;
                localStorage.setItem('quizScore', (currentScore + pointsToAdd).toFixed(1));
                safePlayAudio(document.getElementById('correct-sound'));
            } else {
                // Ù„Ùˆ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø£Ùˆ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©
                messageBox.innerHTML = '<span class="wrong">âœ– Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!</span>';
                safePlayAudio(document.getElementById('wrong-sound'));
            }

            updateScoreDisplay();

            // Ù†Ù†ØªÙ‚Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¹Ø¯ 1.8 Ø«Ø§Ù†ÙŠØ©
            setTimeout(() => {
                messageBox.style.display = "none";
                currentQuestion++;
                if (currentQuestion < questions.length) {
                    loadQuestion();
                } else {
                    endGame();
                }
            }, 1800);
        }

        /* ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ´Ø§Ø´Ø© Ø§Ù„ØªÙ‡Ù†Ø¦Ø© ===== */
        function endGame() {
            // Ù„Ø§ Ù†Ù…Ø³Ø­ usedQuestions â€” Ù†Ø­ØªÙØ¸ Ø¨Ù‡Ø§ ÙƒÙŠ Ù„Ø§ ØªØªÙƒØ±Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¬ÙˆÙ„Ø§Øª Ø¨Ø³Ù‡ÙˆÙ„Ø©
            const finalScore = parseFloat(localStorage.getItem('quizScore')) || START_SCORE;
            const endTime = Date.now();
            const totalTime = Math.floor((endTime - gameStartTime) / 1000);

            // Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
            const playerName = prompt("ğŸ‰ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ø­ÙØ¸ Ù†ØªÙŠØ¬ØªÙƒ:", localStorage.getItem('lastPlayerName') || "Ù„Ø§Ø¹Ø¨");
            if (playerName) {
                localStorage.setItem('lastPlayerName', playerName);
                updateLeaderboard(playerName.trim() || "Ù„Ø§Ø¹Ø¨", finalScore, totalTime);
            }

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ø£Ùˆ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            const messageHtml = `
                <h2 style="color:#2c3e50;">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!</h2>
                <p>ğŸ‰ <strong>Ø£Ø­Ø³Ù†Øª!</strong> Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ <strong>${finalScore}</strong> Ù…Ù† 25 Ù†Ù‚Ø·Ø©!</p>
                <p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙƒÙ„ÙŠ: <strong>${totalTime}</strong> Ø«Ø§Ù†ÙŠØ©</p>
                <div style="margin-top:14px;">
                    <button onclick="restartGame()" style="background:#2ecc71; color:white; border:none; padding:10px 18px; border-radius:8px; font-size:16px; cursor:pointer; margin:5px;">
                        Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                    </button>
                    <button onclick="showLeaderboard()" style="background:#3498db; color:white; border:none; padding:10px 18px; border-radius:8px; font-size:16px; cursor:pointer; margin:5px;">
                        Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
                    </button>
                </div>
            `;
            document.getElementById('question').innerHTML = messageHtml;
            document.getElementById('options').innerHTML = "";
        }

        function restartGame() {
            // Ù†Ø¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ù†Ù‡ÙŠØ¦ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø¬Ø¯ÙŠØ¯
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø· Ù…Ø¹ Ø§Ø­ØªØ±Ø§Ù… usedQuestions
            initGame();
        }

        /* ===== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (Leaderboard) ===== */
        function updateLeaderboard(name, score, time) {
            let players = JSON.parse(localStorage.getItem('mathQuizLeaderboard')) || [];
            name = name.trim() || "Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„";
            const existingIndex = players.findIndex(p => p.name === name);

            if (existingIndex !== -1) {
                const p = players[existingIndex];
                // Ù†Ø­Ø¯Ù‘Ø« Ø¥Ø°Ø§ ØªØ­Ø³Ù†Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ø£Ùˆ Ø§Ù„ÙˆÙ‚Øª Ø£ÙØ¶Ù„ Ø¹Ù†Ø¯ ØªØ³Ø§ÙˆÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·)
                if (score > p.score || (score === p.score && time < p.time)) {
                    p.score = score;
                    p.time = time;
                    p.date = new Date().toLocaleDateString('ar-EG');
                }
                p.attempts = (p.attempts || 1) + 1;
                p.lastAttempt = new Date().toLocaleString('ar-EG');
            } else {
                players.push({
                    name: name,
                    score: score,
                    time: time,
                    date: new Date().toLocaleDateString('ar-EG'),
                    attempts: 1,
                    lastAttempt: new Date().toLocaleString('ar-EG')
                });
            }

            players.sort((a, b) => b.score - a.score || a.time - b.time);
            localStorage.setItem('mathQuizLeaderboard', JSON.stringify(players.slice(0, 10)));

            // Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø³ÙŠØ·Ø© (Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ù†Øµ ÙÙŠ localStorage)
            const backupData = { leaderboard: players.slice(0, 10), lastUpdate: new Date().toISOString() };
            localStorage.setItem('leaderboardBackup', JSON.stringify(backupData));
        }

        function showLeaderboard() {
            let players = JSON.parse(localStorage.getItem('mathQuizLeaderboard')) || [];
            if (!players || players.length === 0) {
                // Ø¬Ø±Ø¨ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                const backup = JSON.parse(localStorage.getItem('leaderboardBackup') || '{}');
                players = (backup && backup.leaderboard) ? backup.leaderboard : [];
            }
            displayLeaderboard(players);
        }

        function displayLeaderboard(players) {
            let html = `
                <div style="max-width:100%; overflow:auto;">
                    <h2 style="color:#f39c12; text-align:center; margin-bottom:10px;">Ø£ÙØ¶Ù„ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>
                    <table style="width:100%; border-collapse:collapse; margin:0 auto;">
                        <tr style="background:#34495e; color:white;">
                            <th style="padding:10px; text-align:center;">Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                            <th style="padding:10px; text-align:right;">Ø§Ù„Ø§Ø³Ù…</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„ÙˆÙ‚Øª</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</th>
                        </tr>
            `;
            if (!players || players.length === 0) {
                html += `<tr><td colspan="5" style="text-align:center; padding:18px; font-size:16px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯!</td></tr>`;
            } else {
                players.forEach((player, idx) => {
                    let medal = "";
                    if (idx === 0) medal = "ğŸ¥‡";
                    else if (idx === 1) medal = "ğŸ¥ˆ";
                    else if (idx === 2) medal = "ğŸ¥‰";
                    html += `
                        <tr style="border-bottom:1px solid #eee; ${idx % 2 === 0 ? 'background: rgba(255,255,255,0.04);' : ''}">
                            <td style="padding:10px; text-align:center; vertical-align:middle;">${medal} ${idx+1}</td>
                            <td style="padding:10px; text-align:right; vertical-align:middle;">${player.name}</td>
                            <td style="padding:10px; text-align:center; vertical-align:middle;">${player.score}</td>
                            <td style="padding:10px; text-align:center; vertical-align:middle;">${player.time} Ø«</td>
                            <td style="padding:10px; text-align:center; vertical-align:middle;">${player.attempts || 1}</td>
                        </tr>
                    `;
                });
            }
            html += `
                    </table>
                    <button onclick="document.getElementById('message').style.display='none'" 
                        style="display:block; margin:12px auto 0; padding:8px 18px; background:#e74c3c; color:white; border:none; border-radius:8px; font-size:15px; cursor:pointer;">
                        Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            `;
            messageEl.innerHTML = html;
            messageEl.style.display = "block";
        }

        /* ====== 50/50 ====== */
        function useFiftyFifty() {
            const currentScore = parseFloat(localStorage.getItem('quizScore')) || START_SCORE;
            if (helpUsed) {
                alert("Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„!");
                return;
            }
            if (currentScore < FIFTY_COST) {
                alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ù†Ù‚Ø§Ø· ÙƒØ§ÙÙŠØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©!");
                return;
            }

            // Ø§Ø®ØªØ± 2 Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙˆÙ‚Ù… Ø¨ØªØ¹Ø·ÙŠÙ„Ù‡Ø§
            const incorrectOptions = Array.from(optionsEl.querySelectorAll('li img'))
                .map((img, idx) => ({src: img.src, idx}))
                .filter(o => !currentShuffledOptions[currentCorrectIndex] || !o.src.includes(currentShuffledOptions[currentCorrectIndex]));

            const toDisable = shuffleArray(incorrectOptions).slice(0, 2);
            toDisable.forEach(it => {
                const li = optionsEl.querySelectorAll('li')[it.idx];
                if (li) {
                    li.classList.add('disabled-option');
                    disabledOptions.push(it.idx);
                }
            });

            // Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·
            localStorage.setItem('quizScore', (currentScore - FIFTY_COST).toFixed(1));
            updateScoreDisplay();
            helpUsed = true;
            fiftyBtn.disabled = true;
            helpMessageEl.textContent = "ØªÙ… Ø®ØµÙ… 0.5 Ù†Ù‚Ø·Ø©";
        }

        /* ====== ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ ====== */
        function skipQuestion() {
            const currentScore = parseFloat(localStorage.getItem('quizScore')) || START_SCORE;
            if (currentScore < SKIP_COST) {
                alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ù†Ù‚Ø§Ø· ÙƒØ§ÙÙŠØ© Ù„ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„!");
                return;
            }
            if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ®Ø·ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ (Ø³ÙŠØªÙ… Ø®ØµÙ… 0.5 Ù†Ù‚Ø·Ø©)")) return;

            // Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·
            localStorage.setItem('quizScore', (currentScore - SKIP_COST).toFixed(1));
            updateScoreDisplay();

            // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ Ø¨Ø¯ÙŠÙ„ Ù…Ù† availableQuestions Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ù‹Ø§
            if (availableQuestions.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                const newQ = availableQuestions[randomIndex];

                // Ù†Ø¶Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙŠ Ù…ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
                questions[currentQuestion] = newQ;

                // Ù†Ø¶ÙŠÙÙ‡Ø§ Ø¥Ù„Ù‰ usedQuestions ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø­ØªÙ‰ Ù„Ø§ ØªØªÙƒØ±Ø± Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹
                const used = JSON.parse(localStorage.getItem('usedQuestions')) || [];
                used.push(newQ.id);
                localStorage.setItem('usedQuestions', JSON.stringify(used));

                // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† availableQuestions
                availableQuestions.splice(randomIndex, 1);

                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø¨Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯
                loadQuestion();
            } else {
                // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¯ÙŠÙ„Ø© â€” Ù†Ù†Ù‡ÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø©
                endGame();
            }
        }

        /* ====== ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø· ====== */
        function updateScoreDisplay() {
            const s = parseFloat(localStorage.getItem('quizScore')) || START_SCORE;
            scoreEl.textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${s.toFixed(1)}`;
        }

        /* ====== Ù…Ø³Ø§Ø¹Ø¯ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø£Ù…Ø§Ù† (Ø¨Ø¹Ø¯ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…) ====== */
        function safePlayAudio(audioEl) {
            if (!audioEl) return;
            if (audioUnlocked) {
                try { audioEl.currentTime = 0; audioEl.play(); } catch (e) { /* ignore */ }
            } else {
                // Ù†Ø¤Ù…Ù† ØªØ´ØºÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„
                const initPlay = () => {
                    audioUnlocked = true;
                    try { audioEl.currentTime = 0; audioEl.play(); } catch (e) {}
                    document.body.removeEventListener('pointerdown', initPlay);
                };
                document.body.addEventListener('pointerdown', initPlay, { once: true });
            }
        }

        /* ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ====== */
        window.onload = function() {
            // Ø§Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø© ÙƒÙ…ØµÙÙˆÙØ©: Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø§
            try {
                const backup = localStorage.getItem('leaderboardBackup');
                if (backup && typeof backup === 'string') {
                    // leave as-is
                }
            } catch (e) {}

            // ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© availableQuestions Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
            loadAvailableQuestionsFromStorage();

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            initGame();
        };

        // expose some functions Ù„Ù„Ø²Ø± onclick ÙÙŠ html
        window.useFiftyFifty = useFiftyFifty;
        window.skipQuestion = skipQuestion;
        window.showLeaderboard = showLeaderboard;
        window.restartGame = restartGame;
    </script>
</body>
</html>
